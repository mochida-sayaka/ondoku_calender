<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🔮 アファメーションカレンダー</title>
  
  <!-- PWA設定 -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#8B5CF6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="音読カレンダー">

  <!-- CSS -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/screens.css">
  <link rel="stylesheet" href="css/stats.css">
  <link rel="stylesheet" href="css/animations.css">
  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
</head>
<body>
  <div class="container">

    <!-- ログイン画面 -->
  <div id="loginScreen" class="screen">
    <div class="container">
      <div class="login-container">
        <h1>🔮 音読カレンダー</h1>
        <p class="subtitle">毎日のアファメーションで英語学習</p>
        
        <div class="login-box">
          <h2>ようこそ！</h2>
          <p class="login-description">Googleアカウントでログインして始めましょう</p>
          
          <button id="googleLoginBtn" class="google-login-btn">
            <svg width="18" height="18" viewBox="0 0 18 18">
              <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
              <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
              <path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/>
              <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
            </svg>
            Googleでログイン
          </button>
          
          <p class="privacy-note">
            ログインすることで、<a href="#">利用規約</a>と<a href="#">プライバシーポリシー</a>に同意したものとみなされます
          </p>
        </div>
      </div>
    </div>
  </div>

    <!-- 設定画面 -->
    <div id="setupScreen" class="screen" style="display: none;">
      <h1>🔮 アファメーションカレンダー</h1>
      <p class="subtitle">あなたの心に響く言葉を、毎日音読しましょう</p>
      
      <div class="setup-card">
        <div class="form-group">
          <label>あなたの名前</label>
          <input type="text" id="studentNameInput" placeholder="例：田中太郎">
        </div>

        <div class="form-group">
          <label>今週の気分は？</label>
          <div class="mood-grid" id="moodGrid">
            <button class="mood-btn" data-mood="gentle">
              <span class="mood-icon">🌸</span>
              <span class="mood-label">Gentle</span>
              <span class="mood-desc">優しく</span>
            </button>
            <button class="mood-btn" data-mood="uplifting">
              <span class="mood-icon">🚀</span>
              <span class="mood-label">Uplifting</span>
              <span class="mood-desc">前向きに</span>
            </button>
            <button class="mood-btn" data-mood="empowering">
              <span class="mood-icon">💪</span>
              <span class="mood-label">Empowering</span>
              <span class="mood-desc">力強く</span>
            </button>
            <button class="mood-btn" data-mood="balanced">
              <span class="mood-icon">🌈</span>
              <span class="mood-label">Balanced</span>
              <span class="mood-desc">ミックス</span>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label>難易度</label>
          <div class="level-grid" id="levelGrid">
            <button class="level-btn" data-level="easy">
              <span>初級</span>
              <small>英検5級/4級</small>
            </button>
            <button class="level-btn" data-level="intermediate">
              <span>中級</span>
              <small>英検3級</small>
            </button>
            <button class="level-btn" data-level="advanced">
              <span>上級</span>
              <small>英検準2級/2級</small>
            </button>
          </div>
          <p class="hint-text">💡 選択したムードの文が足りない場合は、同じレベル内の他のムードも含まれます</p>
        </div>

        <div class="form-group">
          <label>1日何文？</label>
          <div class="count-grid" id="countGrid">
            <button class="count-btn" data-count="1">1文</button>
            <button class="count-btn" data-count="2">2文</button>
            <button class="count-btn" data-count="3">3文</button>
          </div>
        </div>

        <button class="primary-btn" id="drawCardsBtn">
          🔮 今週のカードを引く
        </button>
      </div>
    </div>

    <!-- カレンダー画面 -->
    <div id="calendarScreen" class="screen" style="display: none;">
      <div class="header">
        <h2 id="weekRange"></h2>
        <div style="display: flex; gap: 0.5rem;">
          <button class="secondary-btn" id="statsBtn">📊 統計</button>
          <button class="secondary-btn" id="settingsBtn">⚙️ 設定を変更</button>
          <button class="secondary-btn" id="logoutBtn">🚪 ログアウト</button>
        </div>
      </div>
      <div class="calendar-container" id="calendar"></div>
    </div>

    <!-- アファメーション画面 -->
    <div id="affirmationScreen" class="screen" style="display: none;">
      <div class="header">
        <button class="secondary-btn" id="backBtn">← 戻る</button>
        <h2 id="affirmationDate"></h2>
        <div style="width: 80px;"></div>
      </div>
      
      <div class="affirmation-container">
        <div class="affirmation-card">
          <div class="affirmation-text" id="affirmationText"></div>
          <div class="affirmation-japanese" id="affirmationJapanese" style="display: none;"></div>
          <button class="toggle-btn" id="toggleJapanese">日本語を表示</button>
        </div>

        <div class="audio-controls">
          <button class="audio-btn" id="playModelBtn">
            <span class="btn-icon">🔊</span>
            <span>お手本を聞く</span>
          </button>
          <button class="audio-btn" id="recordBtn">
            <span class="btn-icon">🎤</span>
            <span>録音する</span>
          </button>
        </div>

        <div id="recordingPlayer" style="display: none;">
          <audio id="recordingAudio" controls></audio>
        </div>

        <div class="pagination" id="pagination"></div>

        <button class="primary-btn" id="completeBtn" style="display: none;">
          ✨ 完了して送信
        </button>
      </div>
    </div>

    <!-- 統計画面 -->
    <div id="statsScreen" class="screen" style="display: none;">
      <div class="header">
        <button class="secondary-btn" id="backToCalendarBtn">← カレンダーに戻る</button>
        <h2>📊 学習統計</h2>
        <div style="width: 120px;"></div>
      </div>
      
      <div class="calendar-container" id="statsContainer">
        <!-- 統計カードはJSで動的生成 -->
      </div>
    </div>
  </div>
  
  <!-- 設定モーダル -->
  <div id="settingsModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>⚙️ 設定</h3>
        <button class="close-btn" id="closeSettingsModalBtn">×</button>
      </div>
      <div class="modal-body">
        
        <!-- テーマ選択（アコーディオン） -->
        <div class="accordion-item">
          <button class="accordion-header" data-target="theme-content">
            <span>🎨 テーマ選択</span>
            <span class="accordion-icon">▼</span>
          </button>
          <div class="accordion-content" id="theme-content">
            <div class="theme-grid-full">
              <button class="theme-btn active" data-theme="mystic">
                <span class="theme-emoji">🔮</span>
                <span class="theme-name">ミスティック・タロット</span>
              </button>
              <button class="theme-btn" data-theme="tropical">
                <span class="theme-emoji">🌺</span>
                <span class="theme-name">トロピカル・サマー</span>
              </button>
              <button class="theme-btn" data-theme="snow">
                <span class="theme-emoji">🎄</span>
                <span class="theme-name">ホリデー・スノー</span>
              </button>
              <button class="theme-btn" data-theme="sakura">
                <span class="theme-emoji">🌸</span>
                <span class="theme-name">サクラ・スプリング</span>
              </button>
              <button class="theme-btn" data-theme="ocean">
                <span class="theme-emoji">🌊</span>
                <span class="theme-name">オーシャン・ブリーズ</span>
              </button>
              <button class="theme-btn" data-theme="midnight">
                <span class="theme-emoji">🌙</span>
                <span class="theme-name">ミッドナイト・ドリーム</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- 通知設定（アコーディオン） -->
        <div class="accordion-item">
          <button class="accordion-header" data-target="notification-content">
            <span>🔔 通知設定</span>
            <span class="accordion-icon">▼</span>
          </button>
          <div class="accordion-content" id="notification-content">
            <div class="notification-settings">
              <label class="toggle-label">
                <input type="checkbox" id="notificationToggle">
                <span class="toggle-slider"></span>
                <span class="toggle-text">通知を有効にする</span>
              </label>
              <div class="time-setting" id="timeSetting" style="display: none;">
                <label for="notificationTime">通知時刻</label>
                <input type="time" id="notificationTime" value="09:00">
                <p class="hint-text">💡 毎日この時間に音読の通知が届きます</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- カレンダーリセット（アコーディオン） -->
        <div class="accordion-item">
          <button class="accordion-header" data-target="reset-content">
            <span>🔄 カレンダーをリセット</span>
            <span class="accordion-icon">▼</span>
          </button>
          <div class="accordion-content" id="reset-content">
            <div class="reset-section">
              <p class="warning-text">⚠️ 今週のカードと設定がリセットされます</p>
              <button class="danger-btn" id="resetCalendarBtn">カレンダーをリセット</button>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- 完了サマリーモーダル -->
  <div id="completionSummaryModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>✨ 今日の音読完了！</h3>
        <button class="close-btn" id="closeCompletionSummaryBtn">×</button>
      </div>
      <div class="modal-body">
        <p>今日音読したアファメーション：</p>
        <div id="completedAffirmationsList" class="completed-list"></div>
        <div class="modal-actions">
          <button class="primary-btn" id="shareBtn">📤 シェアする</button>
        </div>
      </div>
    </div>
  </div>

  <!-- シェアモーダル -->
  <div id="shareModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>📤 学習記録をシェア</h3>
        <button class="close-btn" id="closeShareModalBtn">×</button>
      </div>
      <div class="modal-body">
        <div class="share-options">
          <button class="share-option-btn" data-platform="twitter">
            <span class="share-icon">🐦</span>
            <span>Xでシェア</span>
          </button>
          <button class="share-option-btn" data-platform="download">
            <span class="share-icon">💾</span>
            <span>画像をダウンロード</span>
          </button>
        </div>
        <div class="modal-actions">
          <button class="primary-btn" id="closeShareAndReturnBtn">カレンダーに戻る</button>
        </div>
      </div>
    </div>
  </div>
    <!-- 画像生成用のCanvas（非表示） -->
  <canvas id="shareCanvas" style="display: none;"></canvas>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    
    // グローバルに公開
    window.initializeApp = initializeApp;
    window.getFirestore = getFirestore;
    window.getStorage = getStorage;
    window.getAuth = getAuth;
    window.GoogleAuthProvider = GoogleAuthProvider;
    window.signInWithPopup = signInWithPopup;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;
    window.doc = doc;
    window.setDoc = setDoc;
    window.getDoc = getDoc;
  </script>

  <!-- アプリケーションJS（モジュール順に読み込み） -->
  <script src="js/firebase-config.js"></script>
  <script src="js/screen-manager.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/firebase-service.js"></script>
  <script src="js/stats.js"></script>
  <script src="js/calendar.js"></script>
  <script src="js/affirmation.js"></script>
  <script src="js/animations.js"></script>
  <script src="js/modals.js"></script>
  <script src="js/share.js"></script>
  <script src="js/theme.js"></script>
  <script src="js/main.js"></script>

  <!-- Service Worker 登録 -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/ondoku_calender/affirmation/service-worker.js')
          .then((registration) => {
            console.log('✅ Service Worker登録成功:', registration.scope);
          })
          .catch((error) => {
            console.log('❌ Service Worker登録失敗:', error);
          });
      });
    }
  </script>

</body>
</html>