<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ´ ã‚¢ãƒ•ã‚¡ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    
    .card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }
    
    h1 {
      text-align: center;
      color: white;
      margin-bottom: 20px;
      font-size: 28px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 22px;
    }
    
    /* è¨­å®šç”»é¢ */
    .setting-section {
      margin-bottom: 25px;
    }
    
    .setting-label {
      font-weight: 600;
      margin-bottom: 12px;
      color: #555;
      font-size: 16px;
    }
    
    .mood-options, .level-options, .count-options {
      display: grid;
      gap: 10px;
    }
    
    .mood-options {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .option-btn {
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 16px;
      text-align: center;
    }
    
    .option-btn:hover {
      border-color: #667eea;
      transform: translateY(-2px);
    }
    
    .option-btn.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
    }
    
    .big-button {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .big-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    .week-info {
      text-align: center;
      color: #666;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .day-cell {
      aspect-ratio: 1;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid #e0e0e0;
      background: white;
    }
    
    .day-cell.today {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
    }
    
    .day-cell.completed {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }
    
    .day-cell.future {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .day-cell:hover:not(.future) {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .day-label {
      font-size: 11px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    
    .day-icon {
      font-size: 24px;
    }
    
    /* ã‚¢ãƒ•ã‚¡ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º */
    .affirmation-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 15px;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .affirmation-text {
      font-size: 22px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      line-height: 1.5;
      text-align: center;
    }
    
    .affirmation-japanese {
      font-size: 16px;
      color: #666;
      text-align: center;
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(0,0,0,0.1);
    }
    
    .affirmation-japanese.show {
      display: block;
    }
    
    .toggle-japanese {
      text-align: center;
      color: #667eea;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 15px;
    }
    
    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }
    
    .action-btn {
      padding: 12px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }
    
    .play-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .record-btn {
      background: white;
      border: 2px solid #667eea;
      color: #667eea;
    }
    
    .record-btn.recording {
      background: #ff4757;
      color: white;
      border-color: #ff4757;
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
    }
    
    .pagination-btn {
      padding: 8px 16px;
      background: white;
      border: 2px solid #667eea;
      border-radius: 8px;
      color: #667eea;
      cursor: pointer;
      font-weight: 600;
    }
    
    .pagination-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .pagination-info {
      color: #666;
      font-weight: 600;
    }
    
    .done-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #5f27cd 0%, #341f97 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
    }
    
    .hidden {
      display: none;
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 400px) {
      .container {
        padding: 10px;
      }
      
      .card {
        padding: 20px;
      }
      
      .affirmation-text {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”® ã‚¢ãƒ•ã‚¡ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
    
    <!-- è¨­å®šç”»é¢ -->
    <div id="settingScreen" class="card">
      <h2>ä»Šé€±ã®è¨­å®š</h2>
      
      <div class="setting-section">
        <div class="setting-label">ã‚ãªãŸã®åå‰ ğŸ‘¤</div>
        <input type="text" id="quickNameInput" placeholder="ä¾‹: ç”°ä¸­å¤ªéƒ" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 12px; font-size: 16px;">
      </div>
      
      <div class="setting-section">
        <div class="setting-label">ä»Šé€±ã®æ°—åˆ†ã¯ï¼Ÿ ğŸŒŸ</div>
        <div class="mood-options">
          <button class="option-btn" data-mood="gentle">
            ğŸŒ¸ Gentle<br><small>å„ªã—ã</small>
          </button>
          <button class="option-btn" data-mood="uplifting">
            ğŸš€ Uplifting<br><small>å‰å‘ãã«</small>
          </button>
          <button class="option-btn" data-mood="empowering">
            ğŸ’ª Empowering<br><small>åŠ›å¼·ã</small>
          </button>
          <button class="option-btn" data-mood="balanced">
            ğŸŒˆ Balanced<br><small>ãƒŸãƒƒã‚¯ã‚¹</small>
          </button>
        </div>
      </div>
      
      <div class="setting-section">
        <div class="setting-label">é›£æ˜“åº¦ ğŸ“Š</div>
        <div class="level-options">
          <button class="option-btn" data-level="easy">
            åˆç´š<br><small>è‹±æ¤œ5ç´š/4ç´š</small>
          </button>
          <button class="option-btn" data-level="intermediate">
            ä¸­ç´š<br><small>è‹±æ¤œ3ç´š</small>
          </button>
          <button class="option-btn" data-level="advanced">
            ä¸Šç´š<br><small>è‹±æ¤œæº–2ç´š/2ç´š</small>
          </button>
        </div>
      </div>
      
      <div class="setting-section">
        <div class="setting-label">1æ—¥ä½•æ–‡ï¼Ÿ ğŸ”¢</div>
        <div class="count-options">
          <button class="option-btn" data-count="1">1æ–‡</button>
          <button class="option-btn" data-count="2">2æ–‡</button>
          <button class="option-btn" data-count="3">3æ–‡</button>
        </div>
      </div>
      
      <button class="big-button" onclick="drawCards()">
        ğŸ”® ä»Šé€±ã®ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
      </button>
    </div>
    
    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”»é¢ -->
    <div id="calendarScreen" class="card hidden">
      <div class="week-info" id="weekInfo"></div>
      <div class="calendar-grid" id="calendarGrid"></div>
      <button class="big-button" onclick="changeSettings()">
        âš™ï¸ è¨­å®šã‚’å¤‰æ›´
      </button>
    </div>
    
    <!-- ã‚¢ãƒ•ã‚¡ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º -->
    <div id="affirmationScreen" class="card hidden">
      <h2 id="dateTitle"></h2>
      
      <div id="affirmationContainer"></div>
      
      <button class="done-btn" onclick="markAsComplete()">
        âœ… å®Œäº†ã—ã¦é€ä¿¡
      </button>
      
      <button class="big-button" onclick="backToCalendar()" style="background: white; color: #667eea; border: 2px solid #667eea;">
        ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æˆ»ã‚‹
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

    // GAS URLï¼ˆæ—¢å­˜ã®éŸ³èª­ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨åŒã˜ï¼‰
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzRwBx_XrJGvRMC2vAagtknPKD86ME9atrxCbIokJBxJs0K-ZFLBVDihxf3hwop5glf/exec';

    // Firebaseè¨­å®šï¼ˆã‚ãªãŸã®è¨­å®šã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyB1Z5kXS----(æœ¬ä½“ã¯ã¡ã‚ƒã‚“ã¨å…¥ã£ã¦ã‚‹)",
      authDomain: "affirmation-calendar-2975e.firebaseapp.com",
      projectId: "affirmation-calendar-2975e",
      storageBucket: "affirmation-calendar-2975e.firebasestorage.app",
      messagingSenderId: "157108172093",
      appId: "1:157108172093:web:f959a9a01ff4522e368154",
      measurementId: "G-FY4DEB884Q"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    window.currentSettings = null;
    window.weeklyData = null;
    window.currentDayIndex = null;
    window.currentAffirmationIndex = 0;
    window.recordings = [];
    window.mediaRecorder = null;
    window.studentName = localStorage.getItem('studentName') || '';

    // åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', init);

    function init() {
      loadWeeklyData();
      setupSettingButtons();
      updateHeaderWithName();
      
      // åå‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ã‚»ãƒƒãƒˆ
      const quickNameInput = document.getElementById('quickNameInput');
      if (quickNameInput && window.studentName) {
        quickNameInput.value = window.studentName;
      }
    }

    function updateHeaderWithName() {
      const header = document.querySelector('.container h1');
      if (window.studentName) {
        header.textContent = `ğŸ”® ${window.studentName}ã•ã‚“ã®ã‚¢ãƒ•ã‚¡ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³`;
      }
    }

    function loadWeeklyData() {
      const stored = localStorage.getItem('weeklyAffirmations');
      if (stored) {
        window.weeklyData = JSON.parse(stored);
        const weekStart = new Date(window.weeklyData.weekStartDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // é€±ãŒçµ‚ã‚ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const daysDiff = Math.floor((today - weekStart) / (1000 * 60 * 60 * 24));
        if (daysDiff >= 7 || daysDiff < 0) {
          // é€±ãŒçµ‚ã‚ã£ãŸ
          showSettings();
        } else {
          showCalendar();
        }
      } else {
        showSettings();
      }
    }

    function setupSettingButtons() {
      // æ°—åˆ†é¸æŠ
      document.querySelectorAll('[data-mood]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[data-mood]').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        });
      });

      // é›£æ˜“åº¦é¸æŠ
      document.querySelectorAll('[data-level]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[data-level]').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        });
      });

      // æ–‡æ•°é¸æŠ
      document.querySelectorAll('[data-count]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[data-count]').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        });
      });
    }

    window.drawCards = async function() {
      const name = document.getElementById('quickNameInput').value.trim();
      const mood = document.querySelector('[data-mood].selected')?.dataset.mood;
      const level = document.querySelector('[data-level].selected')?.dataset.level;
      const count = parseInt(document.querySelector('[data-count].selected')?.dataset.count);

      if (!name) {
        alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (!mood || !level || !count) {
        alert('ã™ã¹ã¦ã®é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // åå‰ã‚’ä¿å­˜
      window.studentName = name;
      localStorage.setItem('studentName', name);
      updateHeaderWithName();

      // Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
      try {
        const affirmationsRef = collection(db, 'affirmations');
        let q;
        
        if (mood === 'balanced') {
          // ãƒãƒ©ãƒ³ã‚¹ã®å ´åˆã¯å…¨ãƒ ãƒ¼ãƒ‰
          q = query(affirmationsRef, where('level', '==', level));
        } else {
          // ç‰¹å®šã®ãƒ ãƒ¼ãƒ‰
          q = query(
            affirmationsRef,
            where('level', '==', level),
            where('moods', 'array-contains', mood)
          );
        }

        const snapshot = await getDocs(q);
        const allAffirmations = snapshot.docs.map(doc => doc.data());

        if (allAffirmations.length < count * 7) {
          alert('æ¡ä»¶ã«åˆã†ã‚¢ãƒ•ã‚¡ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
          return;
        }

        // 7æ—¥åˆ†ã‚’ãƒ©ãƒ³ãƒ€ãƒ æŠ½å‡ºï¼ˆé‡è¤‡ãªã—ï¼‰
        const shuffled = allAffirmations.sort(() => Math.random() - 0.5);
        const weeklyCards = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let i = 0; i < 7; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() + i);
          
          weeklyCards.push({
            date: date.toISOString().split('T')[0],
            dayOfWeek: i,
            affirmations: shuffled.slice(i * count, (i + 1) * count),
            completed: false
          });
        }

        // LocalStorageã«ä¿å­˜
        window.weeklyData = {
          weekStartDate: today.toISOString().split('T')[0],
          settings: { mood, level, sentencesPerDay: count },
          weeklyCards: weeklyCards
        };

        localStorage.setItem('weeklyAffirmations', JSON.stringify(window.weeklyData));
        
        showCalendar();
      } catch (error) {
        console.error('Error:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    function showSettings() {
      document.getElementById('settingScreen').classList.remove('hidden');
      document.getElementById('calendarScreen').classList.add('hidden');
      document.getElementById('affirmationScreen').classList.add('hidden');
    }

    function showSettings() {
      document.getElementById('settingScreen').classList.remove('hidden');
      document.getElementById('calendarScreen').classList.add('hidden');
      document.getElementById('affirmationScreen').classList.add('hidden');
    }

    function showCalendar() {
      document.getElementById('settingScreen').classList.add('hidden');
      document.getElementById('calendarScreen').classList.remove('hidden');
      document.getElementById('affirmationScreen').classList.add('hidden');

      renderCalendar();
    }

    function renderCalendar() {
      const weekInfo = document.getElementById('weekInfo');
      const grid = document.getElementById('calendarGrid');
      
      const startDate = new Date(window.weeklyData.weekStartDate);
      const endDate = new Date(startDate);
      endDate.setDate(endDate.getDate() + 6);
      
      weekInfo.textContent = `${formatDate(startDate)} ã€œ ${formatDate(endDate)}`;
      
      grid.innerHTML = '';
      const dayLabels = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      window.weeklyData.weeklyCards.forEach((day, index) => {
        const dayDate = new Date(day.date);
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        
        if (dayDate > today) {
          cell.classList.add('future');
        } else if (dayDate.toDateString() === today.toDateString()) {
          cell.classList.add('today');
        }
        
        if (day.completed) {
          cell.classList.add('completed');
        }

        cell.innerHTML = `
          <div class="day-label">${dayLabels[index]}</div>
          <div class="day-icon">${day.completed ? 'âœ…' : 'ğŸ”®'}</div>
        `;

        if (dayDate <= today) {
          cell.addEventListener('click', () => showAffirmation(index));
        }

        grid.appendChild(cell);
      });
    }

    function showAffirmation(dayIndex) {
      window.currentDayIndex = dayIndex;
      window.currentAffirmationIndex = 0;
      window.recordings = [];

      document.getElementById('settingScreen').classList.add('hidden');
      document.getElementById('calendarScreen').classList.add('hidden');
      document.getElementById('affirmationScreen').classList.remove('hidden');

      const day = window.weeklyData.weeklyCards[dayIndex];
      const date = new Date(day.date);
      document.getElementById('dateTitle').textContent = formatDateLong(date);

      renderAffirmations(day.affirmations);
    }

    function renderAffirmations(affirmations) {
      const container = document.getElementById('affirmationContainer');
      container.innerHTML = '';

      affirmations.forEach((aff, index) => {
        const card = document.createElement('div');
        card.innerHTML = `
          <div class="affirmation-card">
            <div class="affirmation-text">${aff.text}</div>
            <div class="toggle-japanese" onclick="toggleJapanese(${index})">
              ğŸ“– æ—¥æœ¬èªã‚’è¦‹ã‚‹ â–¼
            </div>
            <div class="affirmation-japanese" id="japanese-${index}">
              ${aff.japanese}
            </div>
          </div>
          
          <div class="button-group">
            <button class="action-btn play-btn" onclick="playAudio('${aff.modelAudioUrl}')">
              ğŸ”Š ãŠæ‰‹æœ¬
            </button>
            <button class="action-btn record-btn" id="record-${index}" onclick="toggleRecord(${index})">
              ğŸ¤ éŒ²éŸ³
            </button>
          </div>
        `;
        container.appendChild(card);
      });

      if (affirmations.length > 1) {
        const pagination = document.createElement('div');
        pagination.className = 'pagination';
        pagination.innerHTML = `
          <button class="pagination-btn" onclick="prevAffirmation()" id="prevBtn">â† å‰ã¸</button>
          <div class="pagination-info">
            <span id="currentNum">1</span> / ${affirmations.length}
          </div>
          <button class="pagination-btn" onclick="nextAffirmation()" id="nextBtn">æ¬¡ã¸ â†’</button>
        `;
        container.appendChild(pagination);
      }
    }

    window.toggleJapanese = function(index) {
      const elem = document.getElementById(`japanese-${index}`);
      elem.classList.toggle('show');
    };

    window.playAudio = function(url) {
      const audio = new Audio(url);
      audio.play();
    };

    window.toggleRecord = async function(index) {
      const btn = document.getElementById(`record-${index}`);
      
      if (window.mediaRecorder && window.mediaRecorder.state === 'recording') {
        window.mediaRecorder.stop();
        btn.classList.remove('recording');
        btn.textContent = 'ğŸ¤ éŒ²éŸ³';
      } else {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          window.mediaRecorder = new MediaRecorder(stream);
          const chunks = [];

          window.mediaRecorder.ondataavailable = e => chunks.push(e.data);
          window.mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            window.recordings[index] = blob;
            stream.getTracks().forEach(track => track.stop());
          };

          window.mediaRecorder.start();
          btn.classList.add('recording');
          btn.textContent = 'â¹ï¸ åœæ­¢';
        } catch (error) {
          alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
        }
      }
    };

    window.markAsComplete = async function(doneBtn) {
      // åå‰ãƒã‚§ãƒƒã‚¯
      if (!window.studentName) {
        alert('è¨­å®šã‹ã‚‰åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        showStudentSettings();
        return;
      }

      // éŒ²éŸ³ãƒã‚§ãƒƒã‚¯ï¼ˆå°‘ãªãã¨ã‚‚1ã¤éŒ²éŸ³ãŒå¿…è¦ï¼‰
      if (window.recordings.length === 0) {
        alert('å°‘ãªãã¨ã‚‚1æ–‡ã¯éŒ²éŸ³ã—ã¦ãã ã•ã„');
        return;
      }

      const originalText = doneBtn.innerHTML;
      doneBtn.disabled = true;
      doneBtn.innerHTML = '<span class="spinner"></span> é€ä¿¡ä¸­...';
      doneBtn.style.background = '#9ca3af';

      try {
        const day = window.weeklyData.weeklyCards[window.currentDayIndex];
        
        // éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
        for (let i = 0; i < window.recordings.length; i++) {
          if (window.recordings[i]) {
            const reader = new FileReader();
            const audioBlob = window.recordings[i];
            
            await new Promise((resolve, reject) => {
              reader.readAsDataURL(audioBlob);
              reader.onloadend = async () => {
                try {
                  await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                      audioData: reader.result,
                      studentName: window.studentName,
                      day: day.date,
                      affirmation: day.affirmations[i].text,
                      japanese: day.affirmations[i].japanese
                    }),
                  });
                  resolve();
                } catch (err) {
                  reject(err);
                }
              };
            });
          }
        }

        // æœ€ä½1ç§’å¾…ã¤
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // å®Œäº†è¨˜éŒ²
        day.completed = true;
        localStorage.setItem('weeklyAffirmations', JSON.stringify(window.weeklyData));
        
        alert(`âœ¨ ${window.studentName}ã•ã‚“ã®éŸ³èª­ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼`);
        showCalendar();
        
      } catch (err) {
        console.error('Error:', err);
        alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        doneBtn.disabled = false;
        doneBtn.innerHTML = originalText;
        doneBtn.removeAttribute('style');
      }
    };

    window.submitRecording = window.markAsComplete;

    window.showStudentSettings = function() {
      document.getElementById('nameInput').value = window.studentName;
      document.getElementById('settingsModal').classList.remove('hidden');
      document.getElementById('settingsModal').classList.add('show');
    };

    window.closeSettingsModal = function() {
      document.getElementById('settingsModal').classList.remove('show');
      document.getElementById('settingsModal').classList.add('hidden');
    };

    window.saveStudentName = function() {
      const name = document.getElementById('nameInput').value.trim();
      if (name) {
        window.studentName = name;
        localStorage.setItem('studentName', name);
        updateHeaderWithName();
        closeSettingsModal();
        alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
      } else {
        alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      }
    };

    window.backToCalendar = function() {
      showCalendar();
    };

    window.changeSettings = function() {
      const confirmed = confirm('è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ä»Šé€±ã®ã‚«ãƒ¼ãƒ‰ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚\næœ¬å½“ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ');
      if (confirmed) {
        localStorage.removeItem('weeklyAffirmations');
        window.weeklyData = null;
        showSettingsScreen();
      }
    };

    function showSettingsScreen() {
      document.getElementById('settingScreen').classList.remove('hidden');
      document.getElementById('calendarScreen').classList.add('hidden');
      document.getElementById('affirmationScreen').classList.add('hidden');
    }

    function formatDate(date) {
      return `${date.getMonth() + 1}/${date.getDate()}`;
    }

    function formatDateLong(date) {
      const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ï¼ˆ${days[date.getDay()]}ï¼‰`;
    }
  </script>
</body>
</html>
